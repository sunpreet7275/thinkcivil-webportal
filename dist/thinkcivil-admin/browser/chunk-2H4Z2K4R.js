import{a as f,d}from"./chunk-GRH6IN53.js";import{Ec as r,G as g,Ha as n,a as p,aa as a,b as u,bd as h,da as m,fd as v,ia as c,ja as S}from"./chunk-SZ6SDWKT.js";var O=class o{constructor(t){this.http=t;this.loadUserFromStorage(),this.router.events.pipe(g(e=>e instanceof f)).subscribe(e=>{let i=e.url==="/";this.isOnAuthPageSignal.set(i)})}apiUrl=`${v.apiUrl}/auth`;router=S(d);currentUserSignal=n(null);menuItemsSignal=n([]);isOnAuthPageSignal=n(!1);otpStatusSignal=n({sent:!1,verified:!1,email:""});loadUserFromStorage(){let t=localStorage.getItem("token"),e=localStorage.getItem("user"),s=localStorage.getItem("menuItems");t&&e&&s&&(this.currentUserSignal.set(JSON.parse(e)),this.menuItemsSignal.set(JSON.parse(s)));let i=localStorage.getItem("otpStatus");i&&this.otpStatusSignal.set(JSON.parse(i))}isLoggedIn=r(()=>this.isOnAuthPageSignal()?!1:!!this.currentUserSignal());isOTPSent=r(()=>this.otpStatusSignal().sent);isOTPVerified=r(()=>this.otpStatusSignal().verified);otpEmail=r(()=>this.otpStatusSignal().email);otpExpiresAt=r(()=>this.otpStatusSignal().expiresAt);currentUser=r(()=>this.currentUserSignal());menuItems=r(()=>this.menuItemsSignal());sendOTP(t){return this.http.post(`${this.apiUrl}/send-otp`,{email:t}).pipe(a(e=>{if(e.success){let s={sent:!0,verified:!1,email:t,expiresAt:e.expiresAt?new Date(e.expiresAt):void 0};this.otpStatusSignal.set(s),localStorage.setItem("otpStatus",JSON.stringify(s))}}))}verifyOTP(t,e){return this.http.post(`${this.apiUrl}/verify-otp`,{email:t,otp:e}).pipe(a(s=>{if(s.success){let i=this.otpStatusSignal(),l=u(p({},i),{verified:!0});this.otpStatusSignal.set(l),localStorage.setItem("otpStatus",JSON.stringify(l))}}))}resendOTP(t){return this.sendOTP(t)}clearOTPStatus(){this.otpStatusSignal.set({sent:!1,verified:!1,email:""}),localStorage.removeItem("otpStatus")}isOTPValid(){let t=this.otpStatusSignal();return!t.sent||!t.expiresAt?!1:new Date<new Date(t.expiresAt)}register(t){return this.http.post(`${this.apiUrl}/register`,t).pipe(a(e=>{this.clearOTPStatus(),this.setAuthData(e)}))}login(t){return this.http.post(`${this.apiUrl}/login`,t).pipe(a(e=>{this.setAuthData(e)}))}setAuthData(t){localStorage.setItem("token",t.token),localStorage.setItem("user",JSON.stringify(t.user)),localStorage.setItem("menuItems",JSON.stringify(t.menuItems)),this.currentUserSignal.set(t.user),this.menuItemsSignal.set(t.menuItems)}logout(){localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("menuItems"),localStorage.removeItem("otpStatus"),localStorage.removeItem("test_language"),this.clearAllProgress(),this.currentUserSignal.set(null),this.menuItemsSignal.set([]),this.clearOTPStatus(),this.router.navigate(["/login"])}STORAGE_KEY="test_progress_";clearAllProgress(){Object.keys(localStorage).forEach(t=>{t.startsWith(this.STORAGE_KEY)&&localStorage.removeItem(t)})}getToken(){return localStorage.getItem("token")}canRegister(t){let e=this.otpStatusSignal();return e.sent&&e.verified&&e.email===t&&this.isOTPValid()}getOTPRemainingTime(){let t=this.otpStatusSignal();if(!t.expiresAt)return 0;let e=new Date().getTime(),s=new Date(t.expiresAt).getTime();return Math.max(0,Math.floor((s-e)/1e3))}formatRemainingTime(){let t=this.getOTPRemainingTime();if(t<=0)return"00:00";let e=Math.floor(t/60),s=t%60;return`${e.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}sendPasswordResetOTP(t){return this.http.post(`${this.apiUrl}/forgot-password`,{email:t})}verifyPasswordResetOTP(t,e){return this.http.post(`${this.apiUrl}/verify-reset-otp`,{email:t,otp:e})}resetPassword(t,e,s,i){return this.http.post(`${this.apiUrl}/reset-password`,{email:t,otp:e,newPassword:s,confirmPassword:i})}static \u0275fac=function(e){return new(e||o)(c(h))};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{O as a};
