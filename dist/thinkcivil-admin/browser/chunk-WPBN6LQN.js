import{b as re,c as le}from"./chunk-55DL4JCR.js";import{c as he,d as fe,e as _e,f as be,g as ve}from"./chunk-4TA4R672.js";import{a as ye,b as Ee,c as we,d as Se,e as Re,f as De,g as Ie,h as Pe,i as Oe,j as Te,k as ke}from"./chunk-T4LTT3C7.js";import{c as xe}from"./chunk-GHQD5XIY.js";import"./chunk-UG3TAOCT.js";import{a as oe}from"./chunk-T5SKTLKE.js";import{a as W}from"./chunk-2H4Z2K4R.js";import{b as ze}from"./chunk-E24WOTLI.js";import{a as Me}from"./chunk-QBWFBDUQ.js";import"./chunk-CRTYOTUM.js";import{b as ie,d as ae,h as se}from"./chunk-OBP7X3GA.js";import"./chunk-GL2RTCLG.js";import{a as pe,b as ue}from"./chunk-BFQVRRBQ.js";import{a as Ce}from"./chunk-MJ27DAE4.js";import"./chunk-7G2NQBXL.js";import{a as ee,c as te,g as ne}from"./chunk-Y4AHRI4W.js";import{a as ce,b as ge}from"./chunk-XMRX5FRA.js";import{b as q,d as G}from"./chunk-GRH6IN53.js";import{A as T,L as de,N as me,r as K}from"./chunk-7XSJTIVU.js";import"./chunk-ZWY6WOSF.js";import{b as Z,f as Y,k as J,z as X}from"./chunk-MUJPFQ6Z.js";import{$b as I,Db as d,E as k,Eb as N,Fb as y,Ha as C,Mb as a,Nb as i,Ob as M,Oc as U,Pb as _,Pc as $,Qb as b,Sb as E,Tc as Q,Ub as v,Vb as c,Vc as j,Z as z,_b as D,ac as P,ea as B,ec as o,fb as r,fc as x,gc as g,hc as O,ja as f,jc as V,kc as L,lc as F,qc as w,ra as u,rb as R,sa as h,sb as A,sc as S,tc as H,xb as m}from"./chunk-SZ6SDWKT.js";var Be=(()=>{class n{static \u0275fac=function(s){return new(s||n)};static \u0275mod=A({type:n});static \u0275inj=B({imports:[K,T,T]})}return n})();var Ve=["sendQueryDialog"],Le=["chatMessagesContainer"];function Fe(n,t){n&1&&(a(0,"div",7),M(1,"mat-spinner"),a(2,"p"),o(3,"Loading results..."),i()())}function He(n,t){n&1&&(a(0,"div",8)(1,"mat-card")(2,"mat-card-content")(3,"p"),o(4,"No test results available for this student."),i()()()())}function Ue(n,t){n&1&&(a(0,"th",22),o(1,"Test"),i())}function $e(n,t){if(n&1&&(a(0,"td",23)(1,"div",24)(2,"strong"),o(3),i(),a(4,"small"),o(5),w(6,"date"),i()()()),n&2){let e=t.$implicit;r(3),x(e.test.title),r(2),x(S(6,2,e.test.startTime,"medium"))}}function Qe(n,t){n&1&&(a(0,"th",22),o(1,"Score"),i())}function je(n,t){if(n&1&&(a(0,"td",23),o(1),i()),n&2){let e=t.$implicit;r(),O(" ",e.score,"/",e.totalMarks," ")}}function qe(n,t){n&1&&(a(0,"th",22),o(1,"Percentage"),i())}function Ge(n,t){if(n&1&&(a(0,"td",23)(1,"span"),o(2),i()()),n&2){let e=t.$implicit;r(),y("high-score",e.percentage>=80)("medium-score",e.percentage>=60&&e.percentage<80)("low-score",e.percentage<60),r(),g(" ",e.percentage,"% ")}}function Ke(n,t){n&1&&(a(0,"th",22),o(1,"Rank"),i())}function We(n,t){if(n&1&&(a(0,"span",27),o(1),i()),n&2){let e=c().$implicit,s=c(2);N("background",s.getRankColor(e.rank)),r(),O(" ",e.rank,"",s.getOrdinalSuffix(e.rank)," ")}}function Ze(n,t){if(n&1&&(a(0,"span"),o(1),i()),n&2){let e=c().$implicit;r(),g(" out of ",e.totalStudents,"")}}function Ye(n,t){if(n&1&&(a(0,"td",23),m(1,We,2,4,"span",25)(2,Ze,2,1,"span",26),i()),n&2){let e=t.$implicit;r(),d("ngIf",e.rank),r(),d("ngIf",e.totalStudents)}}function Je(n,t){n&1&&(a(0,"th",22),o(1,"Submitted"),i())}function Xe(n,t){if(n&1&&(a(0,"td",23),o(1),w(2,"date"),i()),n&2){let e=t.$implicit;r(),g(" ",S(2,1,e.submittedAt,"medium")," ")}}function et(n,t){n&1&&(a(0,"th",22),o(1,"Actions"),i())}function tt(n,t){if(n&1){let e=E();a(0,"td",23)(1,"button",28),v("click",function(){let l=u(e).$implicit,p=c(2);return h(p.openChat(l))}),a(2,"mat-icon"),o(3,"chat"),i(),o(4," Query "),i(),a(5,"button",29),v("click",function(){let l=u(e).$implicit,p=c(2);return h(p.viewDetailedResult(l))}),a(6,"mat-icon"),o(7,"visibility"),i(),o(8," View Details "),i()()}}function nt(n,t){n&1&&M(0,"tr",30)}function it(n,t){n&1&&M(0,"tr",31)}function at(n,t){if(n&1&&(a(0,"div",9)(1,"mat-card")(2,"mat-card-content")(3,"div",10)(4,"h3"),o(5),i()(),a(6,"table",11),_(7,12),m(8,Ue,2,0,"th",13)(9,$e,7,5,"td",14),b(),_(10,15),m(11,Qe,2,0,"th",13)(12,je,2,2,"td",14),b(),_(13,16),m(14,qe,2,0,"th",13)(15,Ge,3,7,"td",14),b(),_(16,17),m(17,Ke,2,0,"th",13)(18,Ye,3,2,"td",14),b(),_(19,18),m(20,Je,2,0,"th",13)(21,Xe,3,4,"td",14),b(),_(22,19),m(23,et,2,0,"th",13)(24,tt,9,0,"td",14),b(),m(25,nt,1,0,"tr",20)(26,it,1,0,"tr",21),i()()()()),n&2){let e=c();r(5),g(" Results for: ",e.getStudentName()," "),r(),d("dataSource",e.results()),r(19),d("matHeaderRowDef",e.displayedColumns),r(),d("matRowDefColumns",e.displayedColumns)}}function st(n,t){n&1&&(a(0,"div",47),M(1,"mat-spinner",48),a(2,"p"),o(3,"Loading messages..."),i()())}function ot(n,t){n&1&&(a(0,"span",55),o(1,"(edited)"),i())}function rt(n,t){if(n&1&&(a(0,"div",49)(1,"div",50)(2,"span",51),o(3),i(),a(4,"span",52),o(5),w(6,"date"),i(),m(7,ot,2,0,"span",53),i(),a(8,"div",54),o(9),i()()),n&2){let e=t.$implicit,s=c(2);y("sent",e.sender._id===s.currentUserId)("received",e.sender._id!==s.currentUserId)("unread",!e.isRead&&e.sender._id!==s.currentUserId),r(3),x(e.sender.fullName),r(2),x(S(6,10,e.createdAt,"short")),r(2),d("ngIf",e.isEdited),r(2),g(" ",e.message," ")}}function lt(n,t){n&1&&(a(0,"div",56)(1,"p"),o(2,"No messages yet. Start the conversation!"),i()())}function dt(n,t){n&1&&(a(0,"mat-hint"),o(1," Editing message. Press Enter to save, Esc to cancel. "),i())}function mt(n,t){if(n&1){let e=E();a(0,"button",46),v("click",function(){u(e);let l=c(2);return h(l.cancelEdit())}),o(1," Cancel "),i()}}function ct(n,t){if(n&1){let e=E();a(0,"h2",32),o(1),i(),a(2,"mat-dialog-content",33)(3,"div",34)(4,"mat-chip")(5,"mat-icon"),o(6,"person"),i(),o(7),i()(),a(8,"div",35,1),m(10,st,4,0,"div",36)(11,rt,10,13,"div",37)(12,lt,3,0,"div",38),i(),a(13,"div",39)(14,"mat-form-field",40)(15,"mat-label"),o(16,"Type your message..."),i(),a(17,"textarea",41),F("ngModelChange",function(l){u(e);let p=c();return L(p.newMessage,l)||(p.newMessage=l),h(l)}),v("keydown.enter",function(l){u(e);let p=c();return h(p.onEnterKey(l))}),i(),m(18,dt,2,0,"mat-hint",26),i(),a(19,"div",42),m(20,mt,2,0,"button",43),a(21,"button",44),v("click",function(){u(e);let l=c();return h(l.sendMessage())}),a(22,"mat-icon"),o(23),i(),o(24),i()()()(),a(25,"mat-dialog-actions",45)(26,"button",46),v("click",function(){u(e);let l=c();return h(l.closeChatDialog())}),o(27,"Close"),i()()}if(n&2){let e=c();r(),g("Chat about Test: ",e.selectedResult==null||e.selectedResult.test==null?null:e.selectedResult.test.title,""),r(6),g(" ",e.getParticipantName()," "),r(3),d("ngIf",e.chatLoading()),r(),d("ngForOf",e.chatMessages()),r(),d("ngIf",!e.chatLoading()&&e.chatMessages().length===0),r(5),V("ngModel",e.newMessage),d("disabled",!!e.editingMessage),r(),d("ngIf",e.editingMessage),r(2),d("ngIf",e.editingMessage),r(),d("disabled",!e.newMessage.trim()),r(2),x(e.editingMessage?"save":"send"),r(),g(" ",e.editingMessage?"Update":"Send"," ")}}var Ae=class n{sendQueryDialog;chatMessagesContainer;testService=f(Ce);authService=f(W);userService=f(Me);router=f(G);route=f(q);dialog=f(he);results=C([]);students=C([]);chatMessages=C([]);loading=C(!1);chatLoading=C(!1);displayedColumns=["test","score","percentage","rank","submittedAt","actions"];newMessage="";selectedResult=null;dialogRef;editingMessage=null;currentUserId="";selectedStudentId="";chatPollingSubscription;ngOnInit(){this.loadAllStudents();let t=this.authService.currentUser();this.currentUserId=t?.id||"",this.route.queryParams.subscribe(e=>{let s=e.studentId;s&&(this.selectedStudentId=s,this.loadStudentResults(s))})}ngAfterViewChecked(){this.scrollToBottom()}scrollToBottom(){this.chatMessagesContainer&&(this.chatMessagesContainer.nativeElement.scrollTop=this.chatMessagesContainer.nativeElement.scrollHeight)}loadAllStudents(){this.userService.getAllStudents().subscribe({next:t=>{this.students.set(t),t.length>0&&!this.selectedStudentId&&(this.selectedStudentId=t[0]._id,this.loadStudentResults(this.selectedStudentId))},error:t=>{console.error("Error loading students:",t)}})}loadStudentResults(t){this.loading.set(!0),this.userService.getStudentResultsByAdmin(t).subscribe({next:e=>{this.results.set(e),this.loading.set(!1)},error:e=>{console.error("Error loading student results:",e),this.loading.set(!1)}})}onStudentChange(t){this.selectedStudentId=t.value,this.loadStudentResults(this.selectedStudentId)}getStudentName(){let t=this.students().find(e=>e._id===this.selectedStudentId);return t?t.fullName:"Student"}getUnreadCount(t){return!this.chatMessages()||this.chatMessages().length===0?0:this.chatMessages().filter(e=>e.result===t&&!e.isRead&&e.receiver._id===this.currentUserId).length}viewDetailedResult(t){this.router.navigate(["/result-detail",t._id],{queryParams:{testId:t.test._id,studentId:this.selectedStudentId}})}getRankColor(t){return t===1?"gold":t===2?"silver":t===3?"#cd7f32":""}getOrdinalSuffix(t){let e=["th","st","nd","rd"],s=t%100;return e[(s-20)%10]||e[s]||e[0]}openChat(t){this.selectedResult=t,this.newMessage="",this.editingMessage=null,this.chatMessages.set([]),this.dialogRef=this.dialog.open(this.sendQueryDialog,{width:"600px",height:"700px",disableClose:!1}),this.loadChatMessages(t._id),this.startChatPolling(t._id)}loadChatMessages(t){this.chatLoading.set(!0),this.testService.getChatMessages(t).subscribe({next:e=>{this.chatMessages.set(e),this.chatLoading.set(!1),setTimeout(()=>this.scrollToBottom(),100)},error:e=>{console.error("Error loading chat messages:",e),this.chatLoading.set(!1)}})}startChatPolling(t){this.chatPollingSubscription&&this.chatPollingSubscription.unsubscribe(),this.chatPollingSubscription=k(1e4).pipe(z(()=>this.testService.getChatMessages(t))).subscribe({next:e=>{this.chatMessages.set(e),setTimeout(()=>this.scrollToBottom(),100)},error:e=>{console.error("Error polling chat messages:",e)}})}sendMessage(){if(!(!this.newMessage.trim()||!this.selectedResult))if(this.editingMessage)this.updateMessage();else{let t={result:this.selectedResult._id,message:this.newMessage.trim()};this.testService.sendMessage(t).subscribe({next:e=>{this.chatMessages.update(s=>[...s,e]),this.newMessage="",setTimeout(()=>this.scrollToBottom(),100)},error:e=>{console.error("Error sending message:",e)}})}}updateMessage(){!this.editingMessage||!this.newMessage.trim()||this.testService.updateMessage(this.editingMessage._id,this.newMessage.trim()).subscribe({next:t=>{this.chatMessages.update(e=>e.map(s=>s._id===t._id?t:s)),this.cancelEdit(),setTimeout(()=>this.scrollToBottom(),100)},error:t=>{console.error("Error updating message:",t)}})}deleteMessage(t){confirm("Are you sure you want to delete this message?")&&this.testService.deleteMessage(t._id).subscribe({next:()=>{this.chatMessages.update(e=>e.filter(s=>s._id!==t._id))},error:e=>{console.error("Error deleting message:",e)}})}editMessage(t){this.editingMessage=t,this.newMessage=t.message}cancelEdit(){this.editingMessage=null,this.newMessage=""}onEnterKey(t){let e=t;e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())}closeChatDialog(){this.chatPollingSubscription&&this.chatPollingSubscription.unsubscribe(),this.dialogRef&&this.dialogRef.close()}canDeleteMessage(t){return t.sender._id===this.currentUserId||!0}getParticipantName(){if(!this.selectedResult)return"";let t=this.students().find(e=>e._id===this.selectedStudentId);return t?`Chatting with ${t.fullName}`:"Chat"}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=R({type:n,selectors:[["app-admin-results"]],viewQuery:function(e,s){if(e&1&&(D(Ve,5),D(Le,5)),e&2){let l;I(l=P())&&(s.sendQueryDialog=l.first),I(l=P())&&(s.chatMessagesContainer=l.first)}},decls:11,vars:3,consts:[["sendQueryDialog",""],["chatMessagesContainer",""],[1,"admin-results-container"],[1,"header"],["class","loading",4,"ngIf"],["class","no-results",4,"ngIf"],["class","results-content",4,"ngIf"],[1,"loading"],[1,"no-results"],[1,"results-content"],[1,"student-info-header"],["mat-table","",1,"results-table",3,"dataSource"],["matColumnDef","test"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","score"],["matColumnDef","percentage"],["matColumnDef","rank"],["matColumnDef","submittedAt"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mat-header-cell",""],["mat-cell",""],[1,"test-info"],["class","rank-badge",3,"background",4,"ngIf"],[4,"ngIf"],[1,"rank-badge"],["mat-button","","color","accent",3,"click"],["mat-button","","color","primary",3,"click"],["mat-header-row",""],["mat-row",""],["mat-dialog-title",""],[1,"chat-container"],[1,"participant-info"],[1,"chat-messages"],["class","loading-messages",4,"ngIf"],["class","message",3,"sent","received","unread",4,"ngFor","ngForOf"],["class","no-messages",4,"ngIf"],[1,"chat-input"],["appearance","outline",1,"w-100"],["matInput","","rows","3","placeholder","Type your message here...",3,"ngModelChange","keydown.enter","ngModel","disabled"],[1,"chat-actions"],["mat-button","",3,"click",4,"ngIf"],["mat-raised-button","","color","primary",3,"click","disabled"],["align","end"],["mat-button","",3,"click"],[1,"loading-messages"],["diameter","30"],[1,"message"],[1,"message-header"],[1,"sender-name"],[1,"message-time"],["class","edited-badge",4,"ngIf"],[1,"message-content"],[1,"edited-badge"],[1,"no-messages"]],template:function(e,s){e&1&&(a(0,"div",2)(1,"div",3)(2,"h1"),o(3,"Student Test Results"),i(),a(4,"p"),o(5,"View student performance and chat with them"),i()(),m(6,Fe,4,0,"div",4)(7,He,5,0,"div",5)(8,at,27,4,"div",6),i(),m(9,ct,28,12,"ng-template",null,0,H)),e&2&&(r(6),d("ngIf",s.loading()),r(),d("ngIf",!s.loading()&&s.results().length===0),r(),d("ngIf",!s.loading()&&s.results().length>0))},dependencies:[j,U,$,Q,ne,ee,te,ke,ye,we,Ie,Se,Ee,Pe,Re,De,Oe,Te,me,de,ue,pe,ge,ce,ve,fe,be,_e,oe,se,ie,ae,le,re,xe,Be,X,Z,Y,J,ze],styles:[".admin-results-container[_ngcontent-%COMP%]{padding:20px}.header[_ngcontent-%COMP%]{margin-bottom:30px}.header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{color:#3f51b5;margin-bottom:8px}.student-filter[_ngcontent-%COMP%]{margin-top:20px;max-width:400px}.student-info-header[_ngcontent-%COMP%]{margin-bottom:20px;padding:15px;background-color:#f5f5f5;border-radius:8px}.student-info-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:#333}.student-email[_ngcontent-%COMP%]{color:#666;font-size:.9em;font-weight:400}.loading[_ngcontent-%COMP%], .no-results[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px}.no-results[_ngcontent-%COMP%]{text-align:center;color:#666}.results-table[_ngcontent-%COMP%]{width:100%}.test-info[_ngcontent-%COMP%]{display:flex;flex-direction:column}.test-info[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{color:#666;font-size:.85em}.unread-badge[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:5px;color:#fff;padding:2px 8px;border-radius:12px;font-size:.8em;margin-top:5px}.unread-badge[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:14px;width:14px;height:14px}.rank-badge[_ngcontent-%COMP%]{display:inline-block;padding:2px 8px;border-radius:12px;color:#00008b;font-weight:700;margin-right:5px}.high-score[_ngcontent-%COMP%]{color:#4caf50;font-weight:700}.medium-score[_ngcontent-%COMP%]{color:#ff9800;font-weight:700}.low-score[_ngcontent-%COMP%]{color:#f44336;font-weight:700}.participant-info[_ngcontent-%COMP%]{margin-bottom:15px}.chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:500px}.chat-messages[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:10px;border:1px solid #e0e0e0;border-radius:8px;margin-bottom:15px;background-color:#f9f9f9}.message[_ngcontent-%COMP%]{margin-bottom:15px;padding:10px;border-radius:8px;max-width:80%;position:relative}.message.sent[_ngcontent-%COMP%]{background-color:#e3f2fd;margin-left:auto;border-bottom-right-radius:0}.message.received[_ngcontent-%COMP%]{background-color:#f5f5f5;margin-right:auto;border-bottom-left-radius:0}.message.unread[_ngcontent-%COMP%]{background-color:#fff3e0;border-left:3px solid #ff9800}.message-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:.85em}.sender-name[_ngcontent-%COMP%]{font-weight:700;color:#333}.message-time[_ngcontent-%COMP%]{color:#666;font-size:.8em}.edited-badge[_ngcontent-%COMP%]{color:#666;font-style:italic;font-size:.8em}.edit-btn[_ngcontent-%COMP%], .delete-btn[_ngcontent-%COMP%]{width:24px;height:24px;line-height:24px;margin-left:5px}.edit-btn[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%], .delete-btn[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:16px;width:16px;height:16px}.delete-btn[_ngcontent-%COMP%]{color:#f44336}.message-content[_ngcontent-%COMP%]{word-wrap:break-word;white-space:pre-wrap}.reply-to[_ngcontent-%COMP%]{margin-top:5px;padding-top:5px;border-top:1px dashed #ddd;color:#666;font-size:.85em}.no-messages[_ngcontent-%COMP%], .loading-messages[_ngcontent-%COMP%]{text-align:center;color:#999;padding:40px 20px}.chat-input[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px}.chat-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:10px}.w-100[_ngcontent-%COMP%]{width:100%}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar{width:8px}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#f1f1f1;border-radius:4px}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:4px}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background:#a8a8a8}"]})};export{Ae as ResultsComponent};
